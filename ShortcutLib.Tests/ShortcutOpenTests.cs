using Xunit;

namespace ShortcutLib.Tests;

public class ShortcutOpenTests
{
    // --- Target round-trip tests ---

    [Fact]
    public void Open_SimpleLocalTarget_ReturnsCorrectTarget()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\Windows\notepad.exe" });

        var options = Shortcut.Open(lnk);

        Assert.Equal(@"C:\Windows\notepad.exe", options.Target);
    }

    [Fact]
    public void Open_LocalFolder_ReturnsCorrectTarget()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\Windows" });

        var options = Shortcut.Open(lnk);

        Assert.Equal(@"C:\Windows", options.Target);
    }

    [Fact]
    public void Open_RootDrive_ReturnsCorrectTarget()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:" });

        var options = Shortcut.Open(lnk);

        Assert.Equal(@"C:", options.Target);
    }

    [Fact]
    public void Open_NetworkTarget_ReturnsCorrectTarget()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"\\server\share\file.txt" });

        var options = Shortcut.Open(lnk);

        Assert.Equal(@"\\server\share\file.txt", options.Target);
    }

    [Fact]
    public void Open_PrinterLink_SetsIsPrinterLink()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"\\server\printer", IsPrinterLink = true });

        var options = Shortcut.Open(lnk);

        Assert.True(options.IsPrinterLink);
        Assert.Equal(@"\\server\printer", options.Target);
    }

    [Fact]
    public void Open_EnvVarTarget_ReturnsEnvVarPath()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"%windir%\notepad.exe" });

        var options = Shortcut.Open(lnk);

        Assert.Equal(@"%windir%\notepad.exe", options.Target);
    }

    // --- Header field round-trip tests ---

    [Fact]
    public void Open_CreationTime_RoundTrips()
    {
        var dt = new DateTime(2024, 1, 15, 12, 0, 0, DateTimeKind.Utc);
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe", CreationTime = dt });

        var options = Shortcut.Open(lnk);

        Assert.Equal(dt, options.CreationTime);
    }

    [Fact]
    public void Open_AccessTime_RoundTrips()
    {
        var dt = new DateTime(2024, 6, 1, 8, 30, 0, DateTimeKind.Utc);
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe", AccessTime = dt });

        var options = Shortcut.Open(lnk);

        Assert.Equal(dt, options.AccessTime);
    }

    [Fact]
    public void Open_WriteTime_RoundTrips()
    {
        var dt = new DateTime(2024, 12, 31, 23, 59, 59, DateTimeKind.Utc);
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe", WriteTime = dt });

        var options = Shortcut.Open(lnk);

        Assert.Equal(dt, options.WriteTime);
    }

    [Fact]
    public void Open_NullTimestamps_ReturnNull()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe" });

        var options = Shortcut.Open(lnk);

        Assert.Null(options.CreationTime);
        Assert.Null(options.AccessTime);
        Assert.Null(options.WriteTime);
    }

    [Fact]
    public void Open_FileSize_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe", FileSize = 193536 });

        var options = Shortcut.Open(lnk);

        Assert.Equal(193536u, options.FileSize);
    }

    [Fact]
    public void Open_IconIndex_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe", IconIndex = 5 });

        var options = Shortcut.Open(lnk);

        Assert.Equal(5, options.IconIndex);
    }

    [Theory]
    [InlineData(ShortcutWindowStyle.Normal)]
    [InlineData(ShortcutWindowStyle.Maximized)]
    [InlineData(ShortcutWindowStyle.Minimized)]
    public void Open_WindowStyle_RoundTrips(ShortcutWindowStyle style)
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe", WindowStyle = style });

        var options = Shortcut.Open(lnk);

        Assert.Equal(style, options.WindowStyle);
    }

    [Fact]
    public void Open_HotkeyKey_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe", HotkeyKey = 0x54 });

        var options = Shortcut.Open(lnk);

        Assert.Equal(0x54, options.HotkeyKey);
    }

    [Fact]
    public void Open_HotkeyModifiers_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions
        {
            Target = @"C:\test.exe",
            HotkeyKey = 0x54,
            HotkeyModifiers = HotkeyModifiers.Control | HotkeyModifiers.Alt
        });

        var options = Shortcut.Open(lnk);

        Assert.Equal(0x54, options.HotkeyKey);
        Assert.Equal(HotkeyModifiers.Control | HotkeyModifiers.Alt, options.HotkeyModifiers);
    }

    [Fact]
    public void Open_RunAsAdmin_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe", RunAsAdmin = true });

        var options = Shortcut.Open(lnk);

        Assert.True(options.RunAsAdmin);
    }

    [Fact]
    public void Open_UseUnicode_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions
        {
            Target = @"C:\test.exe",
            Description = "Test",
            UseUnicode = true
        });

        var options = Shortcut.Open(lnk);

        Assert.True(options.UseUnicode);
    }

    // --- StringData round-trip tests ---

    [Fact]
    public void Open_Description_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe", Description = "My Shortcut" });

        var options = Shortcut.Open(lnk);

        Assert.Equal("My Shortcut", options.Description);
    }

    [Fact]
    public void Open_RelativePath_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe", RelativePath = @".\bin\test.exe" });

        var options = Shortcut.Open(lnk);

        Assert.Equal(@".\bin\test.exe", options.RelativePath);
    }

    [Fact]
    public void Open_WorkingDirectory_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe", WorkingDirectory = @"C:\Work" });

        var options = Shortcut.Open(lnk);

        Assert.Equal(@"C:\Work", options.WorkingDirectory);
    }

    [Fact]
    public void Open_Arguments_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe", Arguments = "--verbose --output file.txt" });

        var options = Shortcut.Open(lnk);

        Assert.Equal("--verbose --output file.txt", options.Arguments);
    }

    [Fact]
    public void Open_IconLocation_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions { Target = @"C:\test.exe", IconLocation = @"C:\icons\app.ico" });

        var options = Shortcut.Open(lnk);

        Assert.Equal(@"C:\icons\app.ico", options.IconLocation);
    }

    [Fact]
    public void Open_UnicodeStrings_RoundTrip()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions
        {
            Target = @"C:\test.exe",
            Description = "Unicode test description",
            Arguments = "--flag value",
            WorkingDirectory = @"C:\Unicode",
            UseUnicode = true
        });

        var options = Shortcut.Open(lnk);

        Assert.Equal("Unicode test description", options.Description);
        Assert.Equal("--flag value", options.Arguments);
        Assert.Equal(@"C:\Unicode", options.WorkingDirectory);
    }

    // --- LinkInfo round-trip tests ---

    [Fact]
    public void Open_LinkInfo_Local_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions
        {
            Target = @"C:\Windows\notepad.exe",
            LinkInfo = new LinkInfo
            {
                Local = new LocalPathInfo
                {
                    BasePath = @"C:\Windows\notepad.exe",
                    DriveType = 3,
                    DriveSerialNumber = 0x1234ABCD,
                    VolumeLabel = "Windows"
                }
            }
        });

        var options = Shortcut.Open(lnk);

        Assert.NotNull(options.LinkInfo);
        Assert.NotNull(options.LinkInfo.Local);
        Assert.Equal(@"C:\Windows\notepad.exe", options.LinkInfo.Local.BasePath);
        Assert.Equal(3u, options.LinkInfo.Local.DriveType);
        Assert.Equal(0x1234ABCDu, options.LinkInfo.Local.DriveSerialNumber);
        Assert.Equal("Windows", options.LinkInfo.Local.VolumeLabel);
    }

    [Fact]
    public void Open_LinkInfo_Network_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions
        {
            Target = @"\\server\share\docs\report.docx",
            LinkInfo = new LinkInfo
            {
                Network = new NetworkPathInfo
                {
                    ShareName = @"\\server\share",
                    CommonPathSuffix = @"docs\report.docx"
                }
            }
        });

        var options = Shortcut.Open(lnk);

        Assert.NotNull(options.LinkInfo);
        Assert.NotNull(options.LinkInfo.Network);
        Assert.Equal(@"\\server\share", options.LinkInfo.Network.ShareName);
        Assert.Equal(@"docs\report.docx", options.LinkInfo.Network.CommonPathSuffix);
    }

    // --- Extra data block round-trip tests ---

    [Fact]
    public void Open_KnownFolder_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions
        {
            Target = @"C:\test.exe",
            KnownFolder = new KnownFolderData
            {
                FolderId = KnownFolderIds.Windows,
                Offset = 42
            }
        });

        var options = Shortcut.Open(lnk);

        Assert.NotNull(options.KnownFolder);
        Assert.Equal(KnownFolderIds.Windows, options.KnownFolder.FolderId);
        Assert.Equal(42u, options.KnownFolder.Offset);
    }

    [Fact]
    public void Open_SpecialFolder_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions
        {
            Target = @"C:\test.exe",
            SpecialFolder = new SpecialFolderData
            {
                FolderId = 0x0024,
                Offset = 10
            }
        });

        var options = Shortcut.Open(lnk);

        Assert.NotNull(options.SpecialFolder);
        Assert.Equal(0x0024u, options.SpecialFolder.FolderId);
        Assert.Equal(10u, options.SpecialFolder.Offset);
    }

    [Fact]
    public void Open_Tracker_RoundTrips()
    {
        var volumeId = Guid.Parse("a1b2c3d4-e5f6-7890-abcd-ef1234567890");
        var objectId = Guid.Parse("12345678-9abc-def0-1234-567890abcdef");

        byte[] lnk = Shortcut.Create(new ShortcutOptions
        {
            Target = @"C:\test.exe",
            Tracker = new TrackerData
            {
                MachineId = "WORKSTATION01",
                VolumeId = volumeId,
                ObjectId = objectId
            }
        });

        var options = Shortcut.Open(lnk);

        Assert.NotNull(options.Tracker);
        Assert.Equal("WORKSTATION01", options.Tracker.MachineId);
        Assert.Equal(volumeId, options.Tracker.VolumeId);
        Assert.Equal(objectId, options.Tracker.ObjectId);
        Assert.Null(options.Tracker.BirthVolumeId);
        Assert.Null(options.Tracker.BirthObjectId);
    }

    [Fact]
    public void Open_Tracker_WithBirthIds_RoundTrips()
    {
        var volumeId = Guid.Parse("a1b2c3d4-e5f6-7890-abcd-ef1234567890");
        var objectId = Guid.Parse("12345678-9abc-def0-1234-567890abcdef");
        var birthVolumeId = Guid.Parse("aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee");
        var birthObjectId = Guid.Parse("11111111-2222-3333-4444-555555555555");

        byte[] lnk = Shortcut.Create(new ShortcutOptions
        {
            Target = @"C:\test.exe",
            Tracker = new TrackerData
            {
                MachineId = "MYPC",
                VolumeId = volumeId,
                ObjectId = objectId,
                BirthVolumeId = birthVolumeId,
                BirthObjectId = birthObjectId
            }
        });

        var options = Shortcut.Open(lnk);

        Assert.NotNull(options.Tracker);
        Assert.Equal(birthVolumeId, options.Tracker.BirthVolumeId);
        Assert.Equal(birthObjectId, options.Tracker.BirthObjectId);
    }

    [Fact]
    public void Open_PropertyStore_RoundTrips()
    {
        byte[] storeData = [0x01, 0x02, 0x03, 0x04, 0x05];
        byte[] lnk = Shortcut.Create(new ShortcutOptions
        {
            Target = @"C:\test.exe",
            PropertyStoreData = storeData
        });

        var options = Shortcut.Open(lnk);

        Assert.NotNull(options.PropertyStoreData);
        Assert.Equal(storeData, options.PropertyStoreData);
    }

    [Fact]
    public void Open_IconEnvironmentPath_RoundTrips()
    {
        byte[] lnk = Shortcut.Create(new ShortcutOptions
        {
            Target = @"C:\test.exe",
            IconEnvironmentPath = @"%SystemRoot%\system32\shell32.dll"
        });

        var options = Shortcut.Open(lnk);

        Assert.Equal(@"%SystemRoot%\system32\shell32.dll", options.IconEnvironmentPath);
    }

    // --- Full combined round-trip ---

    [Fact]
    public void Open_AllFeatures_RoundTrips()
    {
        var volumeId = Guid.NewGuid();
        var objectId = Guid.NewGuid();
        var creationTime = new DateTime(2024, 1, 15, 12, 0, 0, DateTimeKind.Utc);

        byte[] lnk = Shortcut.Create(new ShortcutOptions
        {
            Target = @"C:\Windows\notepad.exe",
            Arguments = "test.txt",
            Description = "Full-featured shortcut",
            WorkingDirectory = @"C:\Windows",
            IconLocation = @"C:\Windows\notepad.exe",
            IconIndex = 2,
            WindowStyle = ShortcutWindowStyle.Maximized,
            RunAsAdmin = true,
            HotkeyKey = 0x54,
            HotkeyModifiers = HotkeyModifiers.Control | HotkeyModifiers.Alt,
            UseUnicode = true,
            CreationTime = creationTime,
            FileSize = 193536,
            RelativePath = @".\notepad.exe",
            LinkInfo = new LinkInfo
            {
                Local = new LocalPathInfo
                {
                    BasePath = @"C:\Windows\notepad.exe",
                    VolumeLabel = "C"
                }
            },
            KnownFolder = new KnownFolderData { FolderId = KnownFolderIds.Windows },
            Tracker = new TrackerData
            {
                MachineId = "MYPC",
                VolumeId = volumeId,
                ObjectId = objectId
            }
        });

        var options = Shortcut.Open(lnk);

        Assert.Equal(@"C:\Windows\notepad.exe", options.Target);
        Assert.Equal("test.txt", options.Arguments);
        Assert.Equal("Full-featured shortcut", options.Description);
        Assert.Equal(@"C:\Windows", options.WorkingDirectory);
        Assert.Equal(@"C:\Windows\notepad.exe", options.IconLocation);
        Assert.Equal(2, options.IconIndex);
        Assert.Equal(ShortcutWindowStyle.Maximized, options.WindowStyle);
        Assert.True(options.RunAsAdmin);
        Assert.Equal(0x54, options.HotkeyKey);
        Assert.Equal(HotkeyModifiers.Control | HotkeyModifiers.Alt, options.HotkeyModifiers);
        Assert.True(options.UseUnicode);
        Assert.Equal(creationTime, options.CreationTime);
        Assert.Equal(193536u, options.FileSize);
        Assert.Equal(@".\notepad.exe", options.RelativePath);
        Assert.NotNull(options.LinkInfo?.Local);
        Assert.Equal(@"C:\Windows\notepad.exe", options.LinkInfo.Local.BasePath);
        Assert.NotNull(options.KnownFolder);
        Assert.Equal(KnownFolderIds.Windows, options.KnownFolder.FolderId);
        Assert.NotNull(options.Tracker);
        Assert.Equal("MYPC", options.Tracker.MachineId);
        Assert.Equal(volumeId, options.Tracker.VolumeId);
        Assert.Equal(objectId, options.Tracker.ObjectId);
    }

    // --- Validation tests ---

    [Fact]
    public void Open_NullData_ThrowsArgumentNullException()
    {
        Assert.Throws<ArgumentNullException>(() => Shortcut.Open(null!));
    }

    [Fact]
    public void Open_TooShort_ThrowsArgumentException()
    {
        Assert.Throws<ArgumentException>(() => Shortcut.Open(new byte[10]));
    }

    [Fact]
    public void Open_InvalidHeaderSize_ThrowsFormatException()
    {
        byte[] data = new byte[76];
        data[0] = 0xFF; // Invalid header size
        Assert.Throws<FormatException>(() => Shortcut.Open(data));
    }
}
